# Ansible

## Подготовка к работе

1. Проверить установку ансибла на компьютере с которго он будет запускаться - команда sudo ansible --version. Если ансибл не установлен, то установить его.
2. Скопировать каталог ansible в требуемое место. По умолчанию в корень. В конфигурационном файле ansible.cfg при необходимости изменить значение ключа inventory на каталог куда скопирован ansible.
3. Подготовить файл hosts - списка хостов - клиентов и их групп. Все хосты нужно разбить по группам, в зависимости от того какие роли на них должны выполняться.
4. Настроить файл side.yml. По умолчанию там роли - для установки сервера 1с "с нуля". При необходимости файл можно отредактировать. Пример использования всех ролей в файле side ALL.yml. Установить требуемую версию 1С в переменной onec_version_name. При необходимости отредактировать другие переменные. Скопировать инсталяционный файл 1С в каталог, который определен в переменной ins_dir_src.
5. Прописать пользователя - под которым будет запускаться Ансибл в групповых переменных в папке .../group_vars - файлы - имена групп хостов. Обязательно заполнение переменной ansible_user. Иначе его придется прописывать в строке запуска. Пользователь текущего компьютера должен совпадать с пользователями на хостах.
6. Запуск основного плейбука выполняется из каталога Ansible командой ansible-playbook -i hosts side.yml -K
7. Если ошибка: "Using a SSH password instead of a key is not possible because Host Key checking is enabled and sshpass does not support this.  Please add this host's fingerprint to your known_hosts file to manage this host.", то выполнить команду без sudo: export ANSIBLE_HOST_KEY_CHECKING=False

## side.yml

Основной плэйбук - side ALL.yml - именно он и запускается первым, а уже из него запускаются другие плэйбуки ролей. В нем можно переопределить какие роли должны выполняться на каких группах хостов или отдельных хостах. 
Здесь заданы общие переменные, например onec_version_name - устанавливая версия 1С. Также можно переопределить переменные, если требуются их значения, отличные от значений заданных по умолчанию (в соответствующих файлах ролей по путям ...\Имя роли\defaults\main.yml).
Настроено 2 сценария, которые предполагается выполнять на разных группах серверов:
    - установка сервера приложения
    - установка веб сервера и публикация баз
Кроме этого эти сценарии разделены для возможности установки дополнительного сервера приложения 1С на другом порту (например с отладкой и без отладки) и публикации на одном сервере нескольких баз. На данных момент решение таких задач реализовано с помощью создания различных групп хостов, в которые входят одни и теже хосты.
В сценариях установки сервера приложения 1С можно переопределить следующие переменные (которые по умолчанию заданы в папках defaults соответствующих ролей):
    - SRV1CV8_DEBUG: признак необходимости запуска сервера отладки. по умолчанию отладка отключена.
    - SRV1CV8_PORT: Порт запуска ragent, по умолчанию 1540
    - SRV1CV8_REGPORT: Порт запуска rmngr, по умолчанию 1541
    - SRV1CV8_RANGE: Диапазон портов рабочих процессов, по умолчанию 1560:1591
    - RAS_PORT: Порт сервера администрирования, если не задан, то ставиться не будет, по умолчанию 1539.
Т.е. эти переменные будут действовать на все хосты соответствующе группы сценария. 

## siderev2.yml

siderev2.yml - плейбук для запуска функции реструктуризации v2. При необходимости включения данной функции, запускается после отработки основного плейбука. При необходимости файл можно отредактировать, как и другие переменные в нем. Перед запуском скопировать инсталяционный deb пакет JRE в каталог, который определен в переменной install_JRE.
Запуск самого плейбука выполняется из каталога ansible командой ansible-playbook -i hosts siderev2.yml -K

## Инвентори файл hosts

Позволяет распределять хосты по группам хостов и переопределять какие-нибудь переменные для отдельных хостов. Здесь определены настройки публикаций баз 1с на веб серверах. При необходимости можно переопределить и переменные для установки сервера 1С предприятия, например SRV1CV8_DEBUG - признак отладки на сервере.
Часть переменных можно определить в целом для группы хостов. Это можно сделать в файле с именем группы, расположенном в папке .../group_vars
 
## Роли

В данной сборке используется ряд ролей:

    1. install_deb_packages - установка скачанных ранее deb-пакетов. Используется для установки Apache или доп пакетов шрифтов для 1С fontconfig
    - копируются файлы из папки .../inst_deb_dir/deb_dir во временную папку на хосте. inst_deb_dir и deb_dir - определенные переменные
    - устанавливаются скопированные пакеты, описанные в предыдущем пункте
    - удаляются скопированные файлы. 

    2. first_setup - первоначальная настройка перед установкой платформы сервера 1С предприятия. Этой ролью выполняются следующие действия:
    - Копирование шрифтов из папки ./fonts в /usr/share/fonts
    - Создание группы пользователей grp1cv8 и пользователя usr1cv8
    - Создание различных каталогов - расположения программных файлов, специальных каталогов 1С, временных каталогов для инсталляционных файлов
    - Копирование требуемых шрифтов

    3. install_1C. Установка платформы требуемой версии сервера 1С предприятия. Этой ролью выполняются следующие действия:
    - Останавливаются и удаляются службы старый версий 1С. Это действие по умолчанию выполняется, но может быть не выполнено, если переменная flag_Remove_old_1C_service <> true. 
    - копируется файл единого дистрибутива вида setup-full-8.3.21.1393-x86_64.run из папки ins_dir_src/inst_file_name в папку хоста ins_dir_dest. ins_dir_src, inst_file_name и ins_dir_dest - определенные переменные.
    - Устанавливаются серверные компоненты платформы. Требуемые компоненты для установки определяются переменной enable_components, по умолчанию это серверные компоненты. В сценарии установки веб сервера эта переменная переопределяются для установки только компонента ws 

    4. install_ragent. Установка службы сервера 1С. Этой ролью выполняются следующие действия:
    - Подготавливается файл настройки служб по требуемым параметрам (порты, пути к служебным директориям, необходимость и вид отладки и т.д., определенными переменными SRV1CV8_PORT, SRV1CV8_REGPORT, SRV1CV8_RANGE, SRV1CV8_DEBUG)
        При необходимости параметры службы можно отредактировать в файле плэйбука, либо в файле - групповых переменных.
    - Создается символьная ссылка на файл
    - Создаются и запускаются службы ragent, rmngr, rphost, dbgs

    5. install_ras. Установка службы RAS. Этой ролью выполняются следующие действия:
    - Подготавливается файл настройки службы сервера удаленного администрирования по требуемым параметрам (порты ras, ragent, определенными переменными RAS_PORT, SRV1CV8_PORT)
        При необходимости параметры службы можно отредактировать в файле
    - Создается символьная ссылка на файл
    - Создается и запускается служба ras

    6. setup_apache. Настройка appache после ее установки
    - копирование конфигурационных файлов
    - копирование файлов сертификатов. Сертификаты - файлы cert.key и cert.cer должны быть заранее получены и их нужно положить в каталог ..../setup_apache/files/
    - Включение модулей для работы с ssl

    7. restart_apache. Перезапуск службы apache.

    8. publishing. Публикация базы 1С, ее веб сервисов и http сервисов. Т.к. эти данные уникальны для хостов и не могут быть определены для группы, то переменные прописаны в инвентори файле - hosts

    9. monitoring_1C - установка необходимых пакетов и добавление в CRON заданий, для выполнения скрипта zabbix_exporter.py, каждые 30 секунд.

    10. install_JRE. Установка пакета JRE перед включением функции реструктуризации v2. Необходимо создать директорию по пути, указаном в переменной install_JRE файла siderev2.yml, и скопировать туда сам deb пакет перед запускм роли.

    11. enable_rv2. Роль для включения функции реструктуризации v2.
    ВНИМАНИЕ! Если после запуска и успешной отработки данной роли необходимо в дальнейшем запусткать еще плейбуки, то перед их запуском необходмио зайти по пути /etc/, вполнить команду sudo nano environment и закоментить строчку PATH=$PATH:$JAVA_HOME/bin вручную, чтобы она приобрела вид #PATH=$PATH:$JAVA_HOME/bin, иначе последующие плейбуки не будут запускаться, и в целом может нарушится работа прав пользователя для ansible. После того, как необходимость в запуске новых плейбуков не потребуется, нужно вновь раскоментить строчку PATH=$PATH:$JAVA_HOME/bin.

    12. versioning_linux_configs - добавление задачи в CRON для синхронизации кофигурационных файлов сервера с содержимым GitLab.

## Особенности работы

Необходимо скопировать каталог ansible на свой компьютер, например в корень.
Переопределить переменные, описанные выше.
Пользователь на хостах должен быть такой же как и пользователь на компьютере с которого устанавливается. Пароль тоже должен быть одинаковый.
Если нет необходимости выполнять определенную роль, то ее можно закоментить в файле side.yml. 
Например при установке новой версии платформы 1С на хосты, на которые уже есть старая версия 1с, то можно отключить роль first_setup. Для этого можно либо удалить, либо закоментировать строку.
Если требуется на один хост установить несколько служб приложений севера 1с, то нужно заполнить переменные для второй службы и закоментить все роли кроме install_ragent.
Такой же подход можно использовать для публикований дополнительных баз 1с на веб сервере.
Настроить список хостов в файле hosts
Запуск основного плейбука выполняется из каталога Ansible командой ansible-playbook -i hosts side.yml -K. Параметр -K указывает на выполнение некоторых задач под sudo и требует ввода пароля.
